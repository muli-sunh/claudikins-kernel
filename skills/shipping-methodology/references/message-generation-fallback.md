# Message Generation Fallback (S-21)

What to do when commit message or PR description generation fails.

## When Generation Fails

Commit/PR message generation can fail due to:

| Cause | Symptom | Recovery |
|-------|---------|----------|
| Context exhaustion | Agent stops mid-generation | Use template |
| Large diff | Too much to summarise | Summarise manually |
| Complex changes | Can't determine type | Ask human for type |
| API error | Generation times out | Retry or template |

## Fallback Hierarchy

```
1. AI Generation
   └── Success? Use generated message
   └── Fail?
       │
2. Template + Diff Summary
   └── Success? Use template with auto-summary
   └── Fail?
       │
3. Basic Template
   └── Success? Use basic template
   └── Fail?
       │
4. Human Input
   └── Ask human to write message
```

## Fallback Templates

### Commit Message Template

```
<type>(<scope>): <description>

Changes:
<auto-generated file list>

# Manually complete:
# - Add detailed description
# - Reference issues
# - Note breaking changes
```

**Auto-filled:**
```
feat(auth): [DESCRIPTION NEEDED]

Changes:
- src/auth/middleware.ts (modified)
- src/auth/session.ts (added)
- src/auth/__tests__/middleware.test.ts (added)

# Manually complete:
# - Add detailed description
# - Reference issues (Closes #XX)
# - Note breaking changes
```

### PR Body Template

```markdown
## Summary

[TODO: Describe changes]

## Changes

### Files Modified
<auto-generated list>

### Files Added
<auto-generated list>

### Files Deleted
<auto-generated list>

## Testing

- [ ] Tests pass
- [ ] Manual testing done

## Checklist

- [ ] Documentation updated
- [ ] Breaking changes noted
```

## Auto-Generated Content

Even when full generation fails, we can auto-generate:

### File List

```bash
# Get changed files
git diff --name-status HEAD~1

# Output:
# M  src/auth/middleware.ts
# A  src/auth/session.ts
# D  src/old/deprecated.ts
```

### Stats Summary

```bash
# Get change stats
git diff --stat HEAD~1

# Output:
# 3 files changed, 150 insertions(+), 30 deletions(-)
```

### Commit Range Summary

```bash
# Get commits being shipped
git log --oneline main..HEAD

# Output:
# abc123 Add auth middleware
# def456 Add session management
# 789xyz Fix token refresh
```

## Fallback Flow

### Step 1: Try AI Generation

```
Generating commit message...

[Timeout after 30s]

AI generation failed. Using template fallback.
```

### Step 2: Template with Auto-Summary

```
Commit message template:

feat(<scope>): <description>

Files changed:
- src/auth/middleware.ts (modified, +50/-10)
- src/auth/session.ts (added, +100)
- src/auth/types.ts (added, +25)

Stats: 3 files, +175/-10 lines

Please complete:
1. Choose type: [feat] [fix] [refactor] [docs] [chore]
2. Set scope: [auth]
3. Write description: ________________

[Generate from template] [Write manually]
```

### Step 3: Human Input

```
Unable to generate message automatically.

Please write your commit message:

Type: [feat] [fix] [refactor] [docs] [chore]
Scope: ________________
Description: ________________

Body (optional):
________________
________________

Footer (optional):
Closes #________________

[Create message] [Abort]
```

## Type Detection Fallback

When we can't determine change type:

```
Unable to determine change type.

Changed files suggest:
- New files in src/auth/ → possibly "feat"
- Modified test files → possibly "test"
- Only config changes → possibly "chore"

What type of change is this?

[feat - New feature]
[fix - Bug fix]
[refactor - Code refactor]
[docs - Documentation]
[chore - Maintenance]
[test - Tests only]
```

## Scope Detection Fallback

When scope is unclear:

```
Unable to determine scope.

Changed files are in:
- src/auth/ (3 files)
- src/api/ (1 file)
- src/utils/ (1 file)

What is the primary scope?

[auth] [api] [utils] [no scope]
```

## Large Diff Handling

When diff is too large to summarise:

```
Change is too large to summarise automatically.

Stats:
- 50 files changed
- +2,500 / -800 lines

Options:
1. Summarise by directory
2. List major changes only
3. Write summary manually

[Summarise by directory] [Major changes only] [Manual]
```

**Summarise by directory:**
```
## Changes by Area

### src/auth/ (15 files, +800/-200)
Authentication system overhaul

### src/api/ (10 files, +500/-100)
New API endpoints

### src/utils/ (5 files, +200/-50)
Utility refactoring

...
```

## PR Description Fallback

### Minimal Valid PR

If all else fails, create minimal PR:

```markdown
## Summary

See commit messages for details.

## Changes

```
git log --oneline main..HEAD
```

## Checklist

- [x] Code compiles
- [x] Tests pass
```

### Enhancement After Creation

```
PR created with minimal description.

Would you like to enhance it?

[Enhance description] [Leave as is]
```

## Error Messages

### Context Exhaustion

```
Message generation stopped: context limit reached.

Partial message generated:
"feat(auth): Add authentication middleware

This change introduces..."

[Complete manually] [Use partial] [Regenerate shorter]
```

### API Timeout

```
Message generation timed out after 60 seconds.

[Retry] [Use template] [Write manually]
```

### Invalid Output

```
Generated message doesn't follow format.

Generated:
"I've added authentication to the project"

This doesn't follow conventional commits format.

[Fix format] [Use template] [Write manually]
```

## Best Practices

1. **Always have a fallback** - Never block on generation
2. **Auto-fill what you can** - File lists, stats always work
3. **Ask specific questions** - Type/scope dropdowns, not open text
4. **Allow human override** - Generation is suggestion, not mandate
5. **Record fallback usage** - Track for improvement
